<?xml version='1.0' encoding='UTF-8'?>
<odoo>
  <record id="industry_check_harvest_is_from_harvest_location_server_action" model="ir.actions.server">
    <field name="name">Check Harvest Is From Harvest Location</field>
    <field name="model_id" ref="stock.model_stock_picking"/>
    <field name="usage">base_automation</field>
    <field name="state">code</field>
    <field name="code"><![CDATA[if record.picking_type_id.x_is_harvest and not record.location_id.x_is_harvest:
  raise UserError ("Source location shall be eligible for harvest.")
for picking in records:
  for ml in picking.move_line_ids.filtered(lambda line: line.product_id and line.product_id.tracking == 'lot' and not line.lot_id):
    serial = env['ir.sequence'].next_by_code('auto.lot.serial')
    lot = env['stock.lot'].create({
        'name': serial,
        'product_id': ml.product_id.id,
        'company_id': picking.company_id.id,
    })
    ml.write({'lot_id': lot.id})
    ]]></field>
  </record>
</odoo>
