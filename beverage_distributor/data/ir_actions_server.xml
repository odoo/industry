<?xml version='1.0' encoding='UTF-8'?>
<odoo>
    <record id="bom_server_action" model="ir.actions.server">
        <field name="code"><![CDATA[
if (quant := record.x_quantity_by_deposit_product) == 1 and record.x_unit_sale_product.id:
    raise UserError("Unit sale product should be undefined if this product can not be sold in a smaller unit.")
if quant <= 0 and record.x_unit_sale_product: raise UserError("The auto-BOM should contain a positive amount of units.")
if record.x_unit_sale_product:
    existing_bom = env['mrp.bom'].search([('product_tmpl_id', '=',record.x_unit_sale_product.id)], limit=1)
    reordering_rule = env['stock.warehouse.orderpoint'].search_count([('product_id', '=', record.x_unit_sale_product.product_variant_id.id)], limit=1)
    bom_vals = {
        'product_qty': quant,
        'product_uom_id': record.x_unit_sale_product.uom_id.id,
        'type': 'normal',
        'x_parent_product': record.id,
        'x_auto_production': True,
        'bom_line_ids': [(5, 0), (0, 0, {'product_id': record.product_variant_id.id, 'product_qty': 1})],
    }
    if record.x_deposit_product:
        bom_vals['byproduct_ids'] = [(5, 0), (0, 0, {'product_id': record.x_deposit_product.product_variant_id.id, 'product_qty': 1.0})]

    if existing_bom: existing_bom.write(bom_vals)
    else:
        bom_vals['product_tmpl_id'] = record.x_unit_sale_product.id
        env['mrp.bom'].create(bom_vals)
    if not reordering_rule:
        uom_id = env['uom.uom'].search([('relative_factor', '=', quant), ('relative_uom_id', '=', record.x_unit_sale_product.uom_id.id)], limit=1)
        if not uom_id:
            uom_id = env['uom.uom'].create({'relative_factor': quant, 'relative_uom_id': record.x_unit_sale_product.uom_id.id, 'name': f"Pack of {quant} x {record.x_unit_sale_product.uom_id.name}"})
        env['stock.warehouse.orderpoint'].create({
            'product_id': record.x_unit_sale_product.product_variant_id.id,
            'x_parent_product': record.id,
            'replenishment_uom_id': uom_id.id,
            'route_id': env.ref('mrp.route_warehouse0_manufacture').id,
            'location_id': env.ref('stock.stock_location_stock').id,
        })
else:
    existing_bom = env['mrp.bom'].search([('x_parent_product', '=',record.id)], limit=1)
    reordering_rule = env['stock.warehouse.orderpoint'].search([('x_parent_product', '=', record.id)], limit=1)
    if existing_bom: existing_bom.unlink()
    if reordering_rule: reordering_rule.unlink()
]]></field>
        <field name="model_id" ref="product.model_product_template"/>
        <field name="state">code</field>
        <field name="name">Execute Code</field>
    </record>
    <record id="update_sales_taxes_server_action" model="ir.actions.server">
        <field name="code"><![CDATA[
for product in records:
    if product.x_deposit_product_1:
        if (taxes := product.x_deposit_product_1.taxes_id): product['taxes_id'] = [Command.link(id) for id in taxes.ids]
        if (taxes := product.x_deposit_product_1.supplier_taxes_id): product['supplier_taxes_id'] = [Command.link(id) for id in taxes.ids]
    else:
        if (taxes := product.taxes_id.filtered(lambda t: t.tax_group_id.x_is_deposit)): product['taxes_id'] = [Command.unlink(id) for id in taxes.ids]
        if (taxes := product.supplier_taxes_id.filtered(lambda t: t.tax_group_id.x_is_deposit)): product['supplier_taxes_id'] = [Command.unlink(id) for id in taxes.ids]
]]></field>
        <field name="model_id" ref="product.model_product_template"/>
        <field name="state">code</field>
        <field name="name">Execute Code</field>
    </record>
    <record id="update_state" model="ir.actions.server">
        <field name="child_ids" eval="[(6, 0, [ref('mrp.action_production_order_mark_done')])]"/>
        <field name="model_id" ref="mrp.model_mrp_production"/>
        <field name="state">multi</field>
        <field name="name">Execute Existing Actions</field>
    </record>
    <record id="action_make_deposit_storable_delivery_invoice" model="ir.actions.server">
        <field name="code"><![CDATA[
record.write({'invoice_policy':'delivery', 'type': 'consu', 'is_storable': True})
]]></field>
        <field name="model_id" ref="product.model_product_template"/>
        <field name="state">code</field>
        <field name="name">Execute Code</field>
    </record>
    <record id="deposit_taxes_server_action" model="ir.actions.server">
        <field name="code"><![CDATA[
all_taxes = env['account.tax'].search([('name', 'like', 'DEP %'), ('amount', 'in', records.mapped('x_deposit_amount'))])
deposit_tax_group = env['account.tax.group'].search([('x_is_deposit', '=', True)], limit=1)
for product in records:
    product.write({'taxes_id': [Command.unlink(tax) for tax in product.taxes_id.filtered('x_is_deposit').ids], 'supplier_taxes_id': [Command.unlink(tax) for tax in product.supplier_taxes_id.filtered('x_is_deposit').ids]})
    if (taxes := all_taxes.filtered(lambda t: not float_compare(t.amount, product.x_deposit_amount, precision_digits=4))):
        product.write({'taxes_id': [Command.link(taxes.filtered(lambda t: t.type_tax_use == 'sale')[:1].id)],
                       'supplier_taxes_id': [Command.link(taxes.filtered(lambda t: t.type_tax_use == 'purchase')[:1].id)]})
    elif product.x_deposit_amount:
        values = {'name': 'DEP ' + str(product.x_deposit_amount), 'amount': product.x_deposit_amount, 'amount_type': 'fixed', 'tax_group_id': deposit_tax_group.id}
        product.write({'taxes_id': [Command.create(values | {'type_tax_use': 'sale'})], 'supplier_taxes_id': [Command.create(values | {'type_tax_use': 'purchase'})]})
]]></field>
        <field name="model_id" ref="product.model_product_template"/>
        <field name="state">code</field>
        <field name="name">Execute Code</field>
    </record>
</odoo>
