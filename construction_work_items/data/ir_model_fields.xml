<?xml version='1.0' encoding='UTF-8'?>
<odoo>
    <!-- x_work_item fields -->
    <record id="x_name_field_x_work_item" model="ir.model.fields">
        <field name="name">x_name</field>
        <field name="ttype">char</field>
        <field name="field_description">Description</field>
        <field name="model_id" ref="x_work_item_model"/>
        <field name="required" eval="True"/>
    </record>
    <record id="x_active_field_x_work_item" model="ir.model.fields">
        <field name="name">x_active</field>
        <field name="ttype">boolean</field>
        <field name="field_description">Active</field>
        <field name="model_id" ref="x_work_item_model"/>
    </record>
    <record id="x_sequence_field_x_work_item" model="ir.model.fields">
        <field name="name">x_sequence</field>
        <field name="ttype">integer</field>
        <field name="field_description">Sequence</field>
        <field name="model_id" ref="x_work_item_model"/>
    </record>
    <record id="x_is_template_field_x_work_item" model="ir.model.fields">
        <field name="name">x_is_template</field>
        <field name="ttype">boolean</field>
        <field name="field_description">Is Template</field>
        <field name="model_id" ref="x_work_item_model"/>
    </record>
    <record id="x_sale_order_line_id_field_x_work_item" model="ir.model.fields">
        <field name="name">x_sale_order_line_id</field>
        <field name="ttype">many2one</field>
        <field name="field_description">Sale Order Line</field>
        <field name="model_id" ref="x_work_item_model"/>
        <field name="relation">sale.order.line</field>
    </record>
    <record id="x_product_id_field_x_work_item" model="ir.model.fields">
        <field name="name">x_product_id</field>
        <field name="ttype">many2one</field>
        <field name="domain">[('type', '=', 'service')]</field>
        <field name="field_description">Product</field>
        <field name="model_id" ref="x_work_item_model"/>
        <field name="relation">product.product</field>
        <field name="copied" eval="True"/>
    </record>
    <record id="x_unit_id_field_x_work_item" model="ir.model.fields">
        <field name="name">x_unit_id</field>
        <field name="ttype">many2one</field>
        <field name="field_description">Unit</field>
        <field name="model_id" ref="x_work_item_model"/>
        <field name="relation">uom.uom</field>
        <field name="related">x_product_id.uom_id</field>
        <field name="store" eval="False"/>
    </record>
    <record id="x_reference_field_x_work_item" model="ir.model.fields">
        <field name="name">x_reference</field>
        <field name="ttype">char</field>
        <field name="field_description">Reference</field>
        <field name="model_id" ref="x_work_item_model"/>
        <field name="related">x_product_id.default_code</field>
        <field name="store" eval="False"/>
    </record>
    <record id="x_currency_id_field_x_work_item" model="ir.model.fields">
        <field name="name">x_currency_id</field>
        <field name="ttype">many2one</field>
        <field name="field_description">Currency</field>
        <field name="model_id" ref="x_work_item_model"/>
        <field name="related">x_product_id.currency_id</field>
        <field name="relation">res.currency</field>
        <field name="store" eval="False"/>
        <field name="readonly" eval="True"/>
    </record>
    <record id="x_targeted_so_field_x_work_item" model="ir.model.fields">
        <field name="name">x_targeted_so</field>
        <field name="ttype">many2one</field>
        <field name="field_description">Targeted SO</field>
        <field name="model_id" ref="x_work_item_model"/>
        <field name="relation">sale.order</field>
    </record>

    <!-- x_work_item_line fields -->
     <record id="x_name_field_x_work_item_line" model="ir.model.fields">
        <field name="name">x_name</field>
        <field name="ttype">char</field>
        <field name="field_description">Description</field>
        <field name="model_id" ref="x_work_item_line_model"/>
    </record>
    <record id="x_work_item_id_field_x_work_item_line" model="ir.model.fields">
        <field name="name">x_work_item_id</field>
        <field name="ttype">many2one</field>
        <field name="field_description">Work Item</field>
        <field name="model_id" ref="x_work_item_line_model"/>
        <field name="relation">x_work_item</field>
        <field name="required" eval="True"/>
        <field name="on_delete">cascade</field>
    </record>
    <record id="x_sequence_field_x_work_item_line" model="ir.model.fields">
        <field name="name">x_sequence</field>
        <field name="ttype">integer</field>
        <field name="field_description">Sequence</field>
        <field name="model_id" ref="x_work_item_line_model"/>
    </record>
    <record id="x_quantity_field_x_work_item_line" model="ir.model.fields">
        <field name="name">x_quantity</field>
        <field name="ttype">float</field>
        <field name="field_description">Quantity</field>
        <field name="model_id" ref="x_work_item_line_model"/>
    </record>
    <record id="x_product_id_field_x_work_item_line" model="ir.model.fields">
        <field name="name">x_product_id</field>
        <field name="ttype">many2one</field>
        <field name="field_description">Product</field>
        <field name="model_id" ref="x_work_item_line_model"/>
        <field name="relation">product.product</field>
    </record>
    <record id="x_unit_id_field_x_work_item_line" model="ir.model.fields">
        <field name="name">x_unit_id</field>
        <field name="ttype">many2one</field>
        <field name="related">x_product_id.uom_id</field>
        <field name="field_description">Unit</field>
        <field name="model_id" ref="x_work_item_line_model"/>
        <field name="readonly" eval="True"/>
        <field name="relation">uom.uom</field>
        <field name="store" eval="False"/>
    </record>
    <record id="x_currency_id_field_x_work_item_line" model="ir.model.fields">
        <field name="name">x_currency_id</field>
        <field name="ttype">many2one</field>
        <field name="field_description">Currency</field>
        <field name="model_id" ref="x_work_item_line_model"/>
        <field name="related">x_product_id.currency_id</field>
        <field name="relation">res.currency</field>
        <field name="store" eval="False"/>
        <field name="readonly" eval="True"/>
    </record>
    <record id="x_unit_cost_field_x_work_item_line" model="ir.model.fields">
        <field name="name">x_unit_cost</field>
        <field name="ttype">monetary</field>
        <field name="field_description">Unit Cost</field>
        <field name="model_id" ref="x_work_item_line_model"/>
        <field name="currency_field">x_currency_id</field>
    </record>
    <record id="x_unit_price_field_x_work_item_line" model="ir.model.fields">
        <field name="name">x_unit_price</field>
        <field name="ttype">monetary</field>
        <field name="field_description">Unit Price</field>
        <field name="model_id" ref="x_work_item_line_model"/>
        <field name="currency_field">x_currency_id</field>
    </record>
    <record id="x_margin_field_x_work_item_line" model="ir.model.fields">
        <field name="name">x_margin</field>
        <field name="compute"><![CDATA[
for record in self: record['x_margin'] = (record.x_unit_price - record.x_unit_cost) / record.x_unit_price if record.x_unit_price > 0 else False
]]></field>
        <field name="ttype">float</field>
        <field name="depends">x_unit_price, x_unit_cost</field>
        <field name="field_description">Margin</field>
        <field name="model_id" ref="x_work_item_line_model"/>
        <field name="readonly" eval="True"/>
        <field name="selectable" eval="False"/>
        <field name="store" eval="False"/>
    </record>

    <record id="x_work_item_line_ids_field_x_work_item" model="ir.model.fields">
        <field name="name">x_work_item_line_ids</field>
        <field name="ttype">one2many</field>
        <field name="field_description">Work Item Lines</field>
        <field name="model_id" ref="x_work_item_model"/>
        <field name="relation">x_work_item_line</field>
        <field name="relation_field">x_work_item_id</field>
        <field name="copied" eval="True"/>
    </record>
    <record id="x_unit_cost_field_x_work_item" model="ir.model.fields">
        <field name="name">x_unit_cost</field>
        <field name="compute"><![CDATA[
for record in self:
    record['x_unit_cost'] = sum(line.x_unit_cost * line.x_quantity for line in record.x_work_item_line_ids)
]]></field>
        <field name="ttype">monetary</field>
        <field name="depends">x_work_item_line_ids</field>
        <field name="field_description">Unit Cost</field>
        <field name="model_id" ref="x_work_item_model"/>
        <field name="readonly" eval="True"/>
        <field name="selectable" eval="False"/>
        <field name="currency_field">x_currency_id</field>
    </record>
    <record id="x_unit_price_field_x_work_item" model="ir.model.fields">
        <field name="name">x_unit_price</field>
        <field name="compute"><![CDATA[
for record in self:
    record['x_unit_price'] = sum(line.x_unit_price * line.x_quantity for line in record.x_work_item_line_ids)
]]></field>
        <field name="ttype">monetary</field>
        <field name="depends">x_work_item_line_ids</field>
        <field name="field_description">Unit Price</field>
        <field name="model_id" ref="x_work_item_model"/>
        <field name="readonly" eval="True"/>
        <field name="selectable" eval="False"/>
        <field name="currency_field">x_currency_id</field>
    </record>
    <record id="x_unit_margin_field_x_work_item" model="ir.model.fields">
        <field name="name">x_unit_margin</field>
        <field name="compute"><![CDATA[
for record in self:
    record['x_unit_margin'] = (record.x_unit_price - record.x_unit_cost) / record.x_unit_price if record.x_unit_price > 0 else False
]]></field>
        <field name="ttype">float</field>
        <field name="depends">x_unit_price,x_unit_cost</field>
        <field name="field_description">Unit Margin</field>
        <field name="model_id" ref="x_work_item_model"/>
        <field name="readonly" eval="True"/>
        <field name="selectable" eval="False"/>
        <field name="store" eval="False"/>
    </record>

    <!-- Sale Order Line fields -->
    <record id="x_line_work_item_ids_field_sale_order_line" model="ir.model.fields">
        <field name="ttype">one2many</field>
        <field name="field_description">Work Item</field>
        <field name="model_id" ref="sale.model_sale_order_line"/>
        <field name="name">x_line_work_item_ids</field>
        <field name="relation">x_work_item</field>
        <field name="relation_field">x_sale_order_line_id</field>
    </record>
    <record id="x_local_work_item_field_sale_order_line" model="ir.model.fields">
        <field name="ttype">many2one</field>
        <field name="field_description">Local Work Item</field>
        <field name="model_id" ref="sale.model_sale_order_line"/>
        <field name="name">x_local_work_item</field>
        <field name="relation">x_work_item</field>
    </record>
    <record id="x_work_item_product_line_field_sale_order_line" model="ir.model.fields">
        <field name="ttype">many2one</field>
        <field name="field_description">Work Item Product Line</field>
        <field name="model_id" ref="sale.model_sale_order_line"/>
        <field name="name">x_work_item_product_line</field>
        <field name="relation">sale.order.line</field>
    </record>

    <!-- Product fields -->
    <record id="x_product_work_item_ids_field_product_product" model="ir.model.fields">
        <field name="ttype">one2many</field>
        <field name="field_description">Work Item</field>
        <field name="model_id" ref="product.model_product_product"/>
        <field name="name">x_product_work_item_ids</field>
        <field name="relation">x_work_item</field>
        <field name="relation_field">x_product_id</field>
    </record>

    <record id="x_last_tmpl_wi_id_field_product_template" model="ir.model.fields">
        <field name="ttype">many2one</field>
        <field name="field_description">Template Work Item</field>
        <field name="model_id" ref="product.model_product_template"/>
        <field name="name">x_last_tmpl_wi_id</field>
        <field name="relation">x_work_item</field>
    </record>
    <record id="x_work_item_template_id_field_product_product" model="ir.model.fields">
        <field name="compute"><![CDATA[
work_items_data = self.env['x_work_item']._read_group(domain=[('x_product_id', 'in', self.ids), ('x_is_template', '=', True), ('x_active', '=', True)], groupby=['x_product_id'], aggregates=['id:min'])
mapped_data = {x_product_id.id: id for x_product_id, id in work_items_data}
for record in self:
    record['x_work_item_template_id'] = mapped_data.get(record.id, False)
]]></field>
        <field name="ttype">many2one</field>
        <field name="field_description">Work Item Template</field>
        <field name="model_id" ref="product.model_product_product"/>
        <field name="name">x_work_item_template_id</field>
        <field name="readonly" eval="True"/>
        <field name="relation">x_work_item</field>
        <field name="store" eval="False"/>
    </record>
    <record id="x_product_wi_template_id_field_x_work_item" model="ir.model.fields">
        <field name="ttype">many2one</field>
        <field name="related">x_product_id.x_work_item_template_id</field>
        <field name="field_description">Product Work Item Template</field>
        <field name="model_id" ref="x_work_item_model"/>
        <field name="name">x_product_wi_template_id</field>
        <field name="readonly" eval="True"/>
        <field name="relation">x_work_item</field>
        <field name="store" eval="False"/>
    </record>
</odoo>
