<?xml version='1.0' encoding='UTF-8'?>
<odoo>
    <record id="consolidated_down_payment_server_action" model="ir.actions.server">
        <field name="code"><![CDATA[
invoices = []
for partner in records:
    sale_orders = partner.sale_order_ids.filtered(lambda so: so.invoice_status == 'to invoice')
    if len(sale_orders) == 0: continue
    invoice = sale_orders._create_invoices()
    used_invoice_lines = set()
    sequence = 0
    for so in sale_orders:
        last_date = so.x_last_invoice or so.rental_start_date.date() if so.is_rental_order else False
        next_date = min(so.rental_return_date, datetime.datetime.today()).date() if so.is_rental_order else False
        # no grouping is done, so each invoice line is related to 1 sale order line
        invoice_lines = invoice.invoice_line_ids.filtered(lambda line: line.sale_line_ids in so.order_line)
        display_line = env['account.move.line'].create({
            'move_id': invoice.id,
            'display_type': 'line_note',
            'name': '[' + so.display_name + ']' + (last_date.strftime(' %d/%m/%y - ') + next_date.strftime('%d/%m/%y') if so.is_rental_order else ''),
            'sequence': (sequence := sequence + 1),
        })
        ratio = 1
        if so.is_rental_order: ratio = (next_date - last_date).days / so.duration_days
        for line in invoice_lines:
            quantity = (ratio if line.sale_line_ids.is_product_rentable else 1) * line.sale_line_ids.product_uom_qty
            if quantity == 0: continue
            line.write({'quantity': quantity, 'sequence': (sequence := sequence + 1)})
            used_invoice_lines |= set([display_line, line])
        so['x_last_invoice'] = next_date
    invoice['invoice_line_ids'] = [Command.unlink(line.id) for line in invoice.invoice_line_ids if line not in used_invoice_lines]
    if len(invoice.invoice_line_ids) == 0: invoice.unlink()
    else: invoices.append(invoice.id)
if len(invoices) > 0:
    action = env['ir.actions.act_window']._for_xml_id('account.action_move_out_invoice_type')
    action['views'] = [(env.ref('account.view_out_invoice_tree').id, 'list'), (env.ref('account.view_move_form').id, 'form')]
    action['domain'] = [('id', 'in', invoices)]
else: action = {
    'type': 'ir.actions.client',
    'tag': 'display_notification',
    'params': {'title': 'Error', 'message': 'Nothing to invoice.', 'type': 'warning'},
} 
    ]]></field>
        <field name="model_id" ref="base.model_res_partner"/>
        <field name="state">code</field>
        <field name="name">Consolidated Down Payment</field>
    </record>
</odoo>
