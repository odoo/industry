<?xml version='1.0' encoding='UTF-8'?>
<odoo>
<!-- 
    New Models
-->

<!-- Remark Category -->
    <record model="ir.model.fields" id="field_x_remark_category_x_name">
        <field name="model_id" ref="model_x_remark_category"/>
        <field name="ttype">char</field>
        <field name="name">x_name</field>
        <field name="field_description">Name</field>
        <field name="required" eval="True"/>
    </record>
    <record model="ir.model.fields" id="field_x_remark_category_x_color">
        <field name="model_id" ref="model_x_remark_category"/>
        <field name="ttype">integer</field>
        <field name="name">x_color</field>
        <field name="field_description">Color</field>
    </record>
    
<!-- Remark Image -->
    <record model="ir.model.fields" id="field_x_remark_image_x_name">
        <field name="model_id" ref="model_x_remark_image"/>
        <field name="ttype">char</field>
        <field name="name">x_name</field>
        <field name="field_description">Name</field>
    </record>
    <record model="ir.model.fields" id="field_x_remark_image_x_sequence">
        <field name="model_id" ref="model_x_remark_image"/>
        <field name="ttype">integer</field>
        <field name="name">x_sequence</field>
        <field name="field_description">Sequence</field>
    </record>
    <record model="ir.model.fields" id="field_x_remark_image_x_image_1920">
        <field name="model_id" ref="model_x_remark_image"/>
        <field name="ttype">binary</field>
        <field name="name">x_image_1920</field>
        <field name="field_description">Image 1920</field>
    </record>
    <record model="ir.model.fields" id="field_x_remark_image_x_remark_id">
        <field name="model_id" ref="model_x_remark_image"/>
        <field name="ttype">many2one</field>
        <field name="relation">project.task</field>
        <field name="on_delete">cascade</field>
        <field name="name">x_remark_id</field>
        <field name="field_description">Remark</field>
    </record>
    <record model="ir.model.fields" id="field_x_remark_image_x_video_url">
        <field name="model_id" ref="model_x_remark_image"/>
        <field name="ttype">char</field>
        <field name="name">x_video_url</field>
        <field name="field_description">Video URL</field>
    </record>
    <record model="ir.model.fields" id="field_x_remark_image_x_embed_code">
        <field name="model_id" ref="model_x_remark_image"/>
        <field name="ttype">html</field>
        <field name="name">x_embed_code</field>
        <field name="field_description">Embed Code</field>
    </record>
    <record model="ir.model.fields" id="field_x_remark_image_x_can_image_1024_be_zoomed">
        <field name="model_id" ref="model_x_remark_image"/>
        <field name="ttype">html</field>
        <field name="name">x_can_image_1024_be_zoomed</field>
        <field name="field_description">Can image 1024 be zoomed</field>
        <field name="store" eval="True"/>
    </record>

<!-- Remark (is a project task) -->
    <record model="ir.model.fields" id="field_x_remark_x_is_remark">
        <field name="model_id" ref="project.model_project_task"/>
        <field name="ttype">boolean</field>
        <field name="name">x_is_remark</field>
        <field name="field_description">Is Remark</field>
    </record>
    <record model="ir.model.fields" id="field_x_remark_x_date">
        <field name="model_id" ref="project.model_project_task"/>
        <field name="ttype">date</field>
        <field name="name">x_date</field>
        <field name="field_description">Date</field>
        <field name="tracking">1</field>
        <field name="compute"><![CDATA[
for record in self: record['x_date'] = record['x_date'] or datetime.datetime.today().date()
]]></field>
    </record>
    <record model="ir.model.fields" id="field_x_remark_x_reference">
        <field name="model_id" ref="project.model_project_task"/>
        <field name="ttype">char</field>
        <field name="name">x_reference</field>
        <field name="field_description">Reference</field>
        <field name="depends">project_id</field>
        <field name="tracking">1</field>
        <field name="compute"><![CDATA[
for record in self:
    # project already has remarks
    if (project := record.project_id) and (remarks := project.task_ids.filtered(lambda t: t.x_is_remark)) and (last_refs := remarks.filtered(lambda r: r.x_reference).sorted('create_date desc')): 
        pid, rid = last_refs[0].x_reference.split('-')
    # project has no remarks but has SO
    elif project and (so := project.sale_order_id):
        pid, rid = so.name[1:], 0
    # no SO but made from SO
    elif project and (soid := project.name.split('-')[0].strip()).startswith('S') and soid[1:].isnumeric():
        pid, rid = soid[1:], 0
    # should not be possible because project has to exist for a Remark
    else:
        pid, rid = '00000', 0
    record['x_reference'] = f"{pid}-{int(rid) + 1:05d}"
]]></field>
    </record>
    <record model="ir.model.fields" id="field_x_remark_x_location">
        <field name="model_id" ref="project.model_project_task"/>
        <field name="ttype">char</field>
        <field name="name">x_location</field>
        <field name="field_description">Location</field>
        <field name="tracking">1</field>
    </record>
    <record model="ir.model.fields" id="field_x_remark_x_category">
        <field name="model_id" ref="project.model_project_task"/>
        <field name="ttype">many2many</field>
        <field name="relation">x_remark_category</field>
        <field name="name">x_remark_category_ids</field>
        <field name="field_description">Category</field>
        <field name="tracking">1</field>
    </record>
    <record model="ir.model.fields" id="field_x_remark_x_event_id">
        <field name="model_id" ref="project.model_project_task"/>
        <field name="ttype">many2one</field>
        <field name="relation">calendar.event</field>
        <field name="on_delete" eval="False"/>
        <field name="name">x_event_id</field>
        <field name="field_description">Event</field>
    </record>
    <record model="ir.model.fields" id="field_x_remark_x_project_update_id">
        <field name="model_id" ref="project.model_project_task"/>
        <field name="ttype">many2one</field>
        <field name="relation">project.update</field>
        <field name="on_delete" eval="False"/>
        <field name="name">x_update_id</field>
        <field name="field_description">Project Update</field>
    </record>
    <record model="ir.model.fields" id="field_x_remark_x_remark_image">
        <field name="model_id" ref="project.model_project_task"/>
        <field name="ttype">one2many</field>
        <field name="relation">x_remark_image</field>
        <field name="relation_field">x_remark_id</field>
        <field name="name">x_remark_image_ids</field>
        <field name="field_description">Remark Images</field>
        <field name="tracking">1</field>
    </record>
    <record model="ir.model.fields" id="field_x_remark_x_owner_id">
        <field name="model_id" ref="project.model_project_task"/>
        <field name="ttype">many2one</field>
        <field name="relation">res.partner</field>
        <field name="on_delete" eval="False"/>
        <field name="name">x_owner_id</field>
        <field name="field_description">Owner</field>
        <field name="tracking">1</field>
    </record>
    <record model="ir.model.fields" id="field_x_remark_x_stage_id">
        <field name="model_id" ref="project.model_project_task"/>
        <field name="ttype">many2one</field>
        <field name="relation">project.task.type</field>
        <field name="on_delete" eval="False"/>
        <field name="name">x_stage_id</field>
        <field name="field_description">Remark Stage</field>
        <field name="tracking">1</field>
        <field name="group_expand" eval="True"/>
        <field name="domain">[('x_is_remark_stage', '=', True)]</field>
    </record>

<!-- 
    External Models
-->
<!-- project.task.type -->
    <record model="ir.model.fields" id="field_project_task_type_x_is_remark_stage">
        <field name="model_id" ref="project.model_project_task_type"/>
        <field name="ttype">boolean</field>
        <field name="name">x_is_remark_stage</field>
        <field name="field_description">Is Remark Stage</field>
    </record>
<!-- calendar.event -->
    <record model="ir.model.fields" id="field_event_x_project_id">
        <field name="model_id" ref="calendar.model_calendar_event"/>
        <field name="ttype">many2one</field>
        <field name="relation">project.project</field>
        <field name="name">x_project_id</field>
        <field name="field_description">Project</field>
    </record>
    <record model="ir.model.fields" id="field_event_x_remark_ids">
        <field name="model_id" ref="calendar.model_calendar_event"/>
        <field name="ttype">one2many</field>
        <field name="relation">project.task</field>
        <field name="relation_field">x_event_id</field>
        <field name="name">x_remark_ids</field>
        <field name="field_description">Remarks</field>
    </record>
<!-- project.project -->
    <record model="ir.model.fields" id="field_project_x_event_ids">
        <field name="model_id" ref="project.model_project_project"/>
        <field name="ttype">one2many</field>
        <field name="relation">calendar.event</field>
        <field name="relation_field">x_project_id</field>
        <field name="name">x_event_ids</field>
        <field name="field_description">Events</field>
    </record>
    <record model="ir.model.fields" id="field_project_x_remark_ids">
        <field name="model_id" ref="project.model_project_project"/>
        <field name="ttype">one2many</field>
        <field name="relation">project.task</field>
        <field name="relation_field">project_id</field>
        <field name="name">x_remark_ids</field>
        <field name="field_description">Remarks</field>
    </record>
<!-- project.update -->
    <record model="ir.model.fields" id="field_project_update_x_remark_ids">
        <field name="model_id" ref="project.model_project_update"/>
        <field name="ttype">one2many</field>
        <field name="relation">project.task</field>
        <field name="relation_field">x_update_id</field>
        <field name="name">x_remark_ids</field>
        <field name="field_description">Remarks</field>
    </record>
</odoo>
