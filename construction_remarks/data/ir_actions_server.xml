<?xml version='1.0' encoding='UTF-8'?>
<odoo>
    <!-- 
    server action and not compute because otherwise compute generates the same ID if
    creating multiple remarks from a one2many list since they are not saved yet so
    we cannot access the previous reference, resulting in duplicates
    -->
    <record model="ir.actions.server" id="action_x_remark_generate_x_reference_on_create">
        <field name="model_id" ref="project.model_project_task"/>
        <field name="state">code</field>
        <field name="name">Construction - Remarks: Generate Remark Reference on Create</field>
        <field name="code"><![CDATA[
for record in records:
    # project already has remarks
    if (project := record.project_id) and (remarks := project.x_remark_ids) and (last_refs := remarks.filtered(lambda r: r.x_reference).sorted('create_date desc')): 
        pid, rid = last_refs[0].x_reference.split('-')
    # project has no remarks but has SO
    elif project and (so := project.sale_order_id):
        pid, rid = so.name[1:], 0
    # no SO but made from SO
    elif project and (soid := project.name.split('-')[0].strip()).startswith('S') and soid[1:].isnumeric():
        pid, rid = soid[1:], 0
    # should not be possible because project has to exist for a Remark
    else:
        pid, rid = '00000', 0
    record['x_reference'] = f"{pid}-{int(rid) + 1:05d}"
]]></field>
    </record>
    <record model="ir.actions.server" id="action_x_remark_write_project_stage_on_create_or_write">
        <field name="name">Construction - Remarks: Write Stages on Create or Write</field>
        <field name="model_id" ref="project.model_project_task"/>
        <field name="state">code</field>
        <field name="code"><![CDATA[ 
for record in records: 
    if record.x_is_remark:
        record['stage_id'] = record.x_stage_id
        available_stages = record.project_id.type_ids.filtered(lambda s: s.x_is_remark_stage) 
        if not record.x_stage_id and available_stages: record['x_stage_id'] = available_stages[0]
]]></field>
    </record>
    <!-- 
    Use a server action to open an act_window be able to make the context use both 
    ref() (only available in eval="") and active_id (only available in >{}<)
    -->
    <record model="ir.actions.server" id="action_project_x_remark_list_view">
        <field name="name">Open Remarks</field>
        <field name="model_id" ref="project.model_project_task"/>
        <field name="state">code</field>
        <field name="code"><![CDATA[
action = env['ir.actions.act_window']._for_xml_id('construction_remarks.window_action_project_x_remark_list_view')  # Otherwise Remarks embedded becomes the same as the Tasks button 
ctx = env.context.copy()
ctx.update({'search_default_open_remarks': 1, 'default_project_id': record.id if record else env.context.get('active_id'), 'default_x_is_remark': True, 'default_x_is_remark_stage': 1,
            'active_id': record.id if record else env.context.get('active_id'),                                              # Otherwise no topbar
            'active_model': 'project.project', 'parent_action_id': 442,                                                      # Otherwise setting error
            'current_embedded_action_id': env.ref('construction_remarks.construction_remarks_embedded_action_x_remark').id,  # Otherwise button not selected
            'parent_action_embedded_actions': env.context.get('parent_action_embedded_actions', [])})                        # Otherwise no topbar for Remarks
action.update({'context': ctx, 'res_model': 'project.task', 'domain': [('x_is_remark', '=', True), ('project_id', '=', ctx.get('active_id'))]})
]]></field>
    </record>
    <!-- window action to reference in server action to get a proper context -->
    <record model="ir.actions.act_window" id="window_action_project_x_remark_list_view">
    <field name="name">Remarks</field>
    <field name="res_model">project.task</field>
    <field name="view_mode">kanban,list,form</field>
    <field name="domain">[('x_is_remark', '=', True), ('x_stage_id.x_is_remark_stage', '=', True)]</field>
    <field name="view_ids" eval="[(5, 0, 0),
        (0, 0, {'view_mode': 'kanban', 'view_id': ref('view_x_remark_kanban')}),
        (0, 0, {'view_mode': 'list', 'view_id': ref('view_x_remark_list')}),
        (0, 0, {'view_mode': 'form', 'view_id': ref('view_x_remark_form')})]"/>
    </record>
</odoo>
