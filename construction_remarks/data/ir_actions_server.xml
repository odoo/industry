<?xml version='1.0' encoding='UTF-8'?>
<odoo>
    <!-- 
    server action and not compute because otherwise compute generates the same ID if
    creating multiple remarks from a one2many list since they are not saved yet so
    we cannot access the previous reference, resulting in duplicates
    -->
    <record model="ir.actions.server" id="action_x_remark_generate_x_reference_on_create">
        <field name="model_id" ref="project.model_project_task"/>
        <field name="state">code</field>
        <field name="name">Construction - Remarks: Generate Remark Reference on Create</field>
        <field name="code"><![CDATA[
for record in records:
    # project already has remarks
    if (project := record.project_id) and (remarks := project.x_remark_ids) and (last_refs := remarks.filtered(lambda r: r.x_reference).sorted('create_date desc')): 
        pid, rid = last_refs[0].x_reference.split('-')
    # project has no remarks but has SO
    elif project and (so := project.sale_order_id):
        pid, rid = so.name[1:], 0
    # no SO but made from SO
    elif project and (soid := project.name.split('-')[0].strip()).startswith('S') and soid[1:].isnumeric():
        pid, rid = soid[1:], 0
    # should not be possible because project has to exist for a Remark
    else:
        pid, rid = '00000', 0
    record['x_reference'] = f"{pid}-{int(rid) + 1:05d}"
]]></field>
    </record>
    <record model="ir.actions.server" id="action_x_remark_write_project_stage_on_create_or_write">
        <field name="name">Construction - Remarks: Write Stages on Create or Write</field>
        <field name="model_id" ref="project.model_project_task"/>
        <field name="state">code</field>
        <field name="code"><![CDATA[ 
for record in records: 
    if record.x_is_remark:
        record['stage_id'] = record.x_stage_id
        available_stages = record.project_id.type_ids.filtered(lambda s: s.x_is_remark_stage) 
        if not record.x_stage_id and available_stages: record['x_stage_id'] = available_stages[0]
]]></field>
    </record>
</odoo>
