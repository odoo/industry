<?xml version='1.0' encoding='UTF-8'?>
<odoo>
    <record id="action_initialize_sales_order_line_sequence_on_sales_order_create" model="ir.actions.server">
        <field name="model_id" ref="sale.model_sale_order"/>
        <field name="name">Construction Line Numbering: Initialize Sales Order Line Sequence on Sales Order create</field>
        <field name="state">code</field>
        <field name="code"><![CDATA[
sequences = record.order_line.mapped('sequence')
if len(sequences) != len(set(sequences)):  # not all different: create order
    new_sols = []
    for sol_i, sol in enumerate(record.order_line):
        previous_same_sequences = sum(seq == sequences[sol_i] for seq in sequences[:sol_i + 1])
        # Handle duplicates by adding fractional offsets which will be used to order the list
        new_sols.append((sol.id, sol.sequence + (previous_same_sequences / sequences.count(sol.sequence))))
    seqs = {sid: i for (i, (sid, _)) in enumerate(sorted(new_sols, key=lambda soltup: soltup[1]))}         # Associate each sid with its sequence (order) when sorted
else:  # all different: use existing order
    seqs = {sol.id: i for (i, sol) in enumerate(sorted(record.order_line, key=lambda sol: sol.sequence))}  # Associate each sid with its sequence (order) when sorted
for sol in record.order_line: sol['sequence'] = seqs[sol.id] + 1
]]></field>
    </record>
</odoo>
