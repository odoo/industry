<?xml version='1.0' encoding='UTF-8'?>
<odoo>
    <function name="button_immediate_install" model="ir.module.module" eval="[ref('base.module_web_studio', raise_if_not_found=False)]"/>
    <record id="x_setting_field_line_numbering" model="ir.model.fields">
        <field name="ttype">boolean</field>
        <field name="field_description">Line Numbering</field>
        <field name="model_id" ref="base_setup.model_res_config_settings"/>
        <field name="name">x_setting_line_numbering</field>
        <field name="readonly" eval="False"/>
        <field name="store" eval="True"/>
        <field name="compute"><![CDATA[
self['x_setting_line_numbering'] = self.env['ir.config_parameter'].sudo().get_param('construction_configuration.enable_line_numbering') or bool(self.env['ir.module.module'].search_count([('name', '=', 'construction_line_numbering')], limit=1))
]]></field>
    </record>

    <record id="x_setting_field_work_items" model="ir.model.fields">
        <field name="ttype">boolean</field>
        <field name="field_description">Work Items</field>
        <field name="model_id" ref="base_setup.model_res_config_settings"/>
        <field name="name">x_setting_work_items</field>
        <field name="readonly" eval="False"/>
        <field name="store" eval="True"/>
        <field name="compute"><![CDATA[
self['x_setting_work_items'] = self.env['ir.config_parameter'].sudo().get_param('construction_configuration.enable_work_items') or bool(self.env['ir.module.module'].search_count([('name', '=', 'construction_work_items')], limit=1))
]]></field>
    </record>

    <record id="res_config_settings_view_form" model="ir.ui.view">
        <field name="name">res.config.settings.view.form.inherit.construction</field>
        <field name="model">res.config.settings</field>
        <field name="priority" eval="40"/>
        <field name="active" eval="True"/>
        <field name="inherit_id" ref="sale.res_config_settings_view_form" />
        <field name="arch" type="xml">
            <xpath expr="//form" position="inside" >
                <app string="Construction" name="construction">
                    <block title="Quotations &amp; Orders" name="quotations_setting_container">
                        <setting id="custom_line_numbering" help="Display line number in sale orders and invoices for more clarity with your customers">
                            <field name="x_setting_line_numbering" readonly="0"/>
                        </setting>
                        <setting id="custom_work_items" help="Adjust work item pricing and secure your margin straight from quotations based on components.">
                            <field name="x_setting_work_items" readonly="0"/>
                        </setting>
                    </block>
                </app>
            </xpath>
            <xpath expr="//block[@name='quotation_order_setting_container']" position="inside">
                <setting id="custom_line_numbering" help="Display line number in sale orders and invoices for more clarity with your customers">
                    <field name="x_setting_line_numbering" readonly="0"/>
                </setting>
                <setting id="custom_work_items" help="Adjust work item pricing and secure your margin straight from quotations based on components.">
                    <field name="x_setting_work_items" readonly="0"/>
                </setting>
            </xpath>
        </field>
    </record>

    <record id="x_action_activate_line_numbering" model="ir.actions.server">
        <field name="code"><![CDATA[installed = env['ir.config_parameter'].sudo().get_param('construction_configuration.enable_line_numbering')
if not (module := env['ir.module.module'].search([('name', '=', 'construction_line_numbering')], limit=1)) and not installed and record.x_setting_line_numbering:
    action_window = env['ir.module.module'].with_context({'module_name': 'construction_line_numbering'}).button_immediate_install_app()
    env['base.import.module'].with_context(action_window.get('context')).browse(action_window['res_id']).import_module()
    env['ir.config_parameter'].sudo().set_param('construction_configuration.enable_line_numbering', 1)
elif module and installed and not record.x_setting_line_numbering:
    module.button_immediate_uninstall()
    env['ir.config_parameter'].sudo().set_param('construction_configuration.enable_line_numbering', 0)
]]></field>
        <field name="model_id" ref="base_setup.model_res_config_settings"/>
        <field name="state">code</field>
        <field name="name">(Un-)Install Line Numbering</field>
    </record>
    <record id="x_action_activate_work_items" model="ir.actions.server">
        <field name="code"><![CDATA[installed = env['ir.config_parameter'].sudo().get_param('construction_configuration.enable_work_items')
if not (module := env['ir.module.module'].search([('name', '=', 'construction_work_items')], limit=1)) and not installed and record.x_setting_work_items:
    action_window = env['ir.module.module'].with_context({'module_name': 'construction_work_items'}).button_immediate_install_app()
    env['base.import.module'].with_context(action_window.get('context')).browse(action_window['res_id']).import_module()
    env['ir.config_parameter'].sudo().set_param('construction_configuration.enable_work_items', 1)
elif module and installed and not record.x_setting_work_items:
    module.button_immediate_uninstall()
    env['ir.config_parameter'].sudo().set_param('construction_configuration.enable_work_items', 0)
]]></field>
        <field name="model_id" ref="base_setup.model_res_config_settings"/>
        <field name="state">code</field>
        <field name="name">(Un-)Install Work Items</field>
    </record>

    <function name="button_immediate_install" model="ir.module.module" eval="[ref('base.module_web_studio', raise_if_not_found=False)]"/>
    <record id="x_setting_activate_line_numbering" model="base.automation">
        <field name="model_id" ref="base_setup.model_res_config_settings"/>
        <field name="action_server_ids" eval="[(6, 0, [ref('x_action_activate_line_numbering')])]"/>
        <field name="trigger">on_create_or_write</field>
        <field name="name">Activate line numbering setting</field>
        <field name="trigger_field_ids" eval="[(6, 0, [ref('x_setting_field_line_numbering')])]"/>
    </record>
    <record id="x_setting_activate_work_items" model="base.automation">
        <field name="model_id" ref="base_setup.model_res_config_settings"/>
        <field name="action_server_ids" eval="[(6, 0, [ref('x_action_activate_work_items')])]"/>
        <field name="trigger">on_create_or_write</field>
        <field name="name">Activate Work Items setting</field>
        <field name="trigger_field_ids" eval="[(6, 0, [ref('x_setting_field_work_items')])]"/>
    </record>
    <function name="button_immediate_uninstall" model="ir.module.module" eval="[ref('base.module_web_studio', raise_if_not_found=False)]"/>

    <data noupdate="1">
        <record id="res_config_construction" model="res.config.settings">
            <field name="group_project_stages" eval="1"/>
            <field name="group_discount_per_so_line" eval="1"/>
            <field name="group_product_pricelist" eval="1"/>
            <field name="group_warning_sale" eval="1"/>
            <field name="group_warning_purchase" eval="1"/>
            <field name="invoiced_timesheet" eval="'approved'"/> 
            <field name="group_warning_stock" eval="1"/> 
            <field name="group_stock_reception_report" eval="1"/> 
            <field name="group_sale_delivery_address" eval="1"/>
            <field name="documents_product_settings" eval="1"/>
            <field name="documents_hr_settings" eval="1"/>
            <field name="group_analytic_accounting" eval="1"/>
            <field name="group_uom" eval="1"/>
            <field name="group_sale_order_template" eval="1"/>
        </record>
        <function name="execute" model="res.config.settings" eval="[ref('res_config_construction')]"/>
    </data>
</odoo>
