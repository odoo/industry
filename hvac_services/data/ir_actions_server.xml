<?xml version='1.0' encoding='UTF-8'?>
<odoo>
    <record id="update_so_line_quantity" model="ir.actions.server">
        <field name="name">Update SO line Quantity</field>
        <field name="state">code</field>
        <field name="code"><![CDATA[
for so_line in records:
    so_line['product_uom_qty'] = len(so_line.x_maintained_serials_ids)
]]></field>
        <field name="model_id" ref="sale.model_sale_order_line"/>
    </record>
    <record id="update_fs_task_serials_on_create" model="ir.actions.server">
        <field name="name">Update FS Task Serials on create</field>
        <field name="state">code</field>
        <field name="code"><![CDATA[
for task in records:
    for lot_id in task.sale_order_id.order_line.mapped('x_maintained_serials_ids').filtered(lambda l: l and l not in task.x_serials):
        task['x_serials'] = [Command.link(lot_id.id)]
]]></field>
        <field name="model_id" ref="project.model_project_task"/>
    </record>
    <record id="update_fs_task_serials_on_delivery" model="ir.actions.server">
        <field name="name">Update FS Task Serials on Delivery</field>
        <field name="state">code</field>
        <field name="code"><![CDATA[
for stock_pick in records:
    for task in stock_pick.sale_id.tasks_ids.filtered('is_fsm'):
        for move in stock_pick.move_ids:
            if move.product_id.is_storable and move.product_id.tracking == "serial":
                for lot_id in move.lot_ids.filtered(lambda l: l not in task.x_serials):
                    task['x_serials'] = [Command.link(lot_id.id)]
]]></field>
        <field name="model_id" ref="stock.model_stock_picking"/>
    </record>
    <record id="add_sale_order_line_serials_to_sale_order" model="ir.actions.server">
        <field name="name">Set serials of the sale order equal to the serials of its order lines</field>
        <field name="state">code</field>
        <field name="code"><![CDATA[
for so in records:
    so['x_maintained_serials_ids'] = [Command.set(so.order_line.x_maintained_serials_ids.ids)]
]]></field>
        <field name="model_id" ref="sale.model_sale_order"/>
    </record>
    <record id="add_new_device_to_customer" model="ir.actions.server">
        <field name="name">Add new device to customer</field>
        <field name="model_id" ref="x_new_devices"/>
        <field name="state">code</field>
        <field name="code"><![CDATA[
if env['stock.lot'].search([('name', '=', record.x_serial_number),('product_id', '=', record.x_device_id.id)], limit=1):
    raise UserError('This serial number already exists for this product. Make sure to introduce a unique serial number.')
lot = env['stock.lot'].create({'name': record.x_serial_number, 'product_id': record.x_device_id.id, })
picking = env['stock.picking'].create({'partner_id': record.x_partner_id.id,
    'picking_type_id': env.ref('stock.picking_type_out').id,
    'location_id': env.ref('stock.stock_location_suppliers').id,
    'location_dest_id': env.ref('stock.stock_location_customers').id,
})
env['stock.move.line'].create({'picking_id': picking.id, 'lot_id': lot.id, 'product_id': record.x_device_id.id, 'quantity': 1, })
picking.with_context(skip_sms=True).button_validate()
picking.write({'date_done': record.x_delivery_date})
action = {'type': 'ir.actions.client', 'tag': 'display_notification','params': {'type': 'success', 'sticky': False,'message': ("New device created."), 'next': {'type': 'ir.actions.act_window_close'}, }}
    ]]></field>
    </record>
    <record id="server_action_share_document" model="ir.actions.server">
        <field name="name">Open related document share popup</field>
        <field name="state">code</field>
        <field name="code"><![CDATA[
action = env['documents.sharing'].action_open(record.document_ids.ids)
]]></field>
        <field name="model_id" ref="product.model_product_document"/>
    </record>
</odoo>
