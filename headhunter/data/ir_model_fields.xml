<?xml version='1.0' encoding='UTF-8'?>
<odoo>
    <record id="x_opportunities" model="ir.model.fields">
        <field name="name">x_opportunities</field>
        <field name="model_id" ref="hr_recruitment.model_hr_applicant"/>
        <field name="field_description">Opportunities</field>
        <field name="relation">crm.lead</field>
        <field name="relation_table">x_crm_lead_hr_applicant_rel</field>
        <field name="ttype">many2many</field>
    </record>
    <record id="x_opportunities_count" model="ir.model.fields">
        <field name="name">x_opportunities_count</field>
        <field name="model_id" ref="crm.model_crm_lead"/>
        <field name="field_description">Opportunities count</field>
        <field name="selectable" eval="False"/>
        <field name="store" eval="False"/>
        <field name="ttype">integer</field>
        <field name="compute"><![CDATA[for record in self: record['x_opportunities_count'] = self.env['hr.applicant'].search_count([('x_opportunities', '=', record.id)])]]></field>
    </record>
    <record id="x_stage_name_field" model="ir.model.fields">
        <field name="name">x_stage_name</field>
        <field name="model_id" ref="hr_recruitment.model_hr_applicant"/>
        <field name="field_description">Stage Name</field>
        <field name="ttype">char</field>
        <field name="related">stage_id.name</field>
    </record>
    <record id="x_applicant_ids_field" model="ir.model.fields">
        <field name="name">x_applicant_ids</field>
        <field name="model_id" ref="hr_skills.model_hr_employee_cv_wizard"/>
        <field name="field_description">Stage Name</field>
        <field name="ttype">many2many</field>
        <field name="relation">hr.applicant</field>
        <field name="relation_table">hr_employee_cv_wizard_x_applicant_rel</field>
    </record>
    <record id="x_is_shared_cv_field" model="ir.model.fields">
        <field name="name">x_is_shared_cv</field>
        <field name="field_description">Shared CV</field>
        <field name="model_id" ref="hr_recruitment.model_hr_applicant"/>
        <field name="ttype">many2many</field>
        <field name="relation">ir.attachment</field>
    </record>
    <record id="x_available_field" model="ir.model.fields">
        <field name="name">x_available</field>
        <field name="field_description">Available</field>
        <field name="model_id" ref="hr_recruitment.model_hr_applicant" />
        <field name="ttype">boolean</field>
    </record>
    <record id="x_quotation_sales_order_field" model="ir.model.fields">
        <field name="name">x_quotation_sales_order</field>
        <field name="field_description">Quotation/Sales order</field>
        <field name="model_id" ref="hr.model_hr_job"/>
        <field name="ttype">many2one</field>
        <field name="relation">sale.order</field>
    </record>
    <record id="x_opportunity_field" model="ir.model.fields">
        <field name="name">x_opportunity</field>
        <field name="field_description">Opportunity</field>
        <field name="model_id" ref="hr.model_hr_job"/>
        <field name="ttype">many2one</field>
        <field name="relation">crm.lead</field>
    </record>
    <record id="x_status_bar_field" model="ir.model.fields">
        <field name="name">x_status_bar</field>
        <field name="field_description">Pipeline status bar</field>
        <field name="model_id" ref="hr.model_hr_job"/>
        <field name="ttype">selection</field>
        <field name="tracking">1</field>
    </record>
    <record id="x_status_bar_draft_value" model="ir.model.fields.selection">
        <field name="name">Draft</field>
        <field name="field_id" ref="x_status_bar_field" />
        <field name="value">draft</field>
    </record>
    <record id="x_status_bar_open_value" model="ir.model.fields.selection">
        <field name="name">Open</field>
        <field name="field_id" ref="x_status_bar_field" />
        <field name="value">open</field>
    </record>
    <record id="x_status_bar_done_value" model="ir.model.fields.selection">
        <field name="name">Done</field>
        <field name="field_id" ref="x_status_bar_field" />
        <field name="value">done</field>
    </record>
    <record id="x_recruitment_type_field" model="ir.model.fields">
        <field name="name">x_recruitment_type</field>
        <field name="field_description">Recruitment Type</field>
        <field name="model_id" ref="hr.model_hr_job"/>
        <field name="ttype">selection</field>
    </record>
    <record id="x_recruitment_type_external_value" model="ir.model.fields.selection">
        <field name="name">External</field>
        <field name="field_id" ref="x_recruitment_type_field" />
        <field name="value">External</field>
    </record>
    <record id="x_recruitment_type_internal_value" model="ir.model.fields.selection">
        <field name="name">Internal</field>
        <field name="field_id" ref="x_recruitment_type_field" />
        <field name="value">Internal</field>
    </record>
    <record id="x_customer_field" model="ir.model.fields">
        <field name="name">x_customer</field>
        <field name="field_description">Customer</field>
        <field name="model_id" ref="hr.model_hr_job"/>
        <field name="ttype">many2one</field>
        <field name="relation">res.partner</field>
    </record>
    <record id="x_hiring_team_contact_field" model="ir.model.fields">
        <field name="name">x_hiring_team_contact</field>
        <field name="field_description">Hiring Team Contact</field>
        <field name="model_id" ref="hr.model_hr_job"/>
        <field name="ttype">many2many</field>
        <field name="relation">res.partner</field>
        <field name="relation_table">x_hr_job_res_partner_rel</field>
        <field name="tracking">1</field>
        <field name="depends">x_customer, x_recruitment_type</field>
        <field name="compute"><![CDATA[
for record in self:
    if record.x_recruitment_type == 'Internal':
        record['x_customer'] = False
        record['x_hiring_team_contact'] = False
    else:
        record['x_hiring_team_contact'] = record.x_customer | record.x_customer.child_ids
]]></field>
    </record>
    <record id="x_customer_children_ids_field" model="ir.model.fields">
        <field name="name">x_customer_children_ids</field>
        <field name="field_description">New Many2Many</field>
        <field name="model_id" ref="hr.model_hr_job"/>
        <field name="depends">x_customer, x_customer.child_ids</field>
        <field name="ttype">many2many</field>
        <field name="compute"><![CDATA[for record in self:
        if record.x_customer:
            record['x_customer_children_ids'] = record.x_customer | record.x_customer.child_ids
        else:
            record['x_customer_children_ids'] = False]]></field>
        <field name="relation">res.partner</field>
        <field name="relation_table">x_hr_job_res_partner_rel_1</field>
        <field name="on_delete" eval="False"/>
        <field name="readonly" eval="True"/>
    </record>
    <record id="x_job_position_field" model="ir.model.fields">
        <field name="name">x_job_position</field>
        <field name="field_description">Job Position</field>
        <field name="model_id" ref="account.model_account_move"/>
        <field name="ttype">many2one</field>
        <field name="relation">hr.job</field>
    </record>
    <record id="x_invoices_job_position_field" model="ir.model.fields">
        <field name="name">x_invoices</field>
        <field name="field_description">Invoices</field>
        <field name="model_id" ref="hr.model_hr_job"/>
        <field name="ttype">one2many</field>
        <field name="relation">account.move</field>
        <field name="relation_field">x_job_position</field>
    </record>
    <record id="x_invoice_count_field" model="ir.model.fields">
        <field name="name">x_invoice_count</field>
        <field name="field_description">Invoice Count</field>
        <field name="model_id" ref="hr.model_hr_job"/>
        <field name="ttype">integer</field>
        <field name="depends">x_invoices</field>
        <field name="compute"><![CDATA[
for record in self: record['x_invoice_count'] = len(record.x_invoices)
]]></field>
    </record>
    <record id="x_job_id_field" model="ir.model.fields">
        <field name="name">x_job_id</field>
        <field name="field_description">Job Position</field>
        <field name="model_id" ref="sale.model_sale_order"/>
        <field name="ttype">many2one</field>
        <field name="relation">hr.job</field>
    </record>
    <record id="x_has_portal_access_field" model="ir.model.fields">
        <field name="name">x_has_portal_access</field>
        <field name="ttype">boolean</field>
        <field name="field_description">Has Portal Access</field>
        <field name="model_id" ref="hr.model_hr_job"/>
        <field name="depends">x_hiring_team_contact.user_ids</field>
        <field name="readonly" eval="True"/>
        <field name="store" eval="False"/>
        <field name="compute"><![CDATA[
for job in self:
    job['x_has_portal_access'] = any(
        not partner.user_ids or not partner.user_ids[0]._is_portal()
        for partner in job.x_hiring_team_contact
    )
]]></field>
    </record>
    <record id="x_client_description_field" model="ir.model.fields">
        <field name="name">x_client_description</field>
        <field name="model_id" ref="hr.model_hr_job"/>
        <field name="field_description">Client Description</field>
        <field name="ttype">html</field>
        <field name="translate">html_translate</field>
    </record>
    <record id="x_job_description_field" model="ir.model.fields">
        <field name="name">x_job_description</field>
        <field name="model_id" ref="hr.model_hr_job"/>
        <field name="field_description">Job Description</field>
        <field name="ttype">html</field>
        <field name="translate">html_translate</field>
    </record>
    <record id="x_applicant_description_field" model="ir.model.fields">
        <field name="name">x_applicant_description</field>
        <field name="model_id" ref="hr.model_hr_job"/>
        <field name="field_description">Applicant Description</field>
        <field name="ttype">html</field>
        <field name="translate">html_translate</field>
    </record>
    <record id="x_offer_description_field" model="ir.model.fields">
        <field name="name">x_offer_description</field>
        <field name="model_id" ref="hr.model_hr_job"/>
        <field name="field_description">Offer Description</field>
        <field name="ttype">html</field>
        <field name="translate">html_translate</field>
    </record>
    <record id="x_similar_job_ids_field" model="ir.model.fields">
        <field name="name">x_similar_job_ids</field>
        <field name="field_description">Similar Job Positions</field>
        <field name="model_id" ref="hr.model_hr_job"/>
        <field name="ttype">many2many</field>
        <field name="relation">hr.job</field>
        <field name="relation_table">x_hr_job_hr_job_rel</field>
    </record>
    <record id="x_matching_percentage_field" model="ir.model.fields">
        <field name="name">x_matching_percentage</field>
        <field name="field_description">Matching %</field>
        <field name="model_id" ref="hr.model_hr_job"/>
        <field name="ttype">float</field>
        <field name="store" eval="False"/>
        <field name="depends">current_job_skill_ids,current_job_skill_ids.skill_id,x_similar_job_ids,x_similar_job_ids.current_job_skill_ids,x_similar_job_ids.current_job_skill_ids.skill_id</field>
        <field name="compute"><![CDATA[
for job in self:
    if not job.current_job_skill_ids or not job.x_similar_job_ids:
        job['x_matching_percentage'] = 0.0
        continue

    best_match = 0.0
    job_skill_ids = job.current_job_skill_ids.mapped("skill_id")

    for similar in job.x_similar_job_ids:
        similar_skill_ids = similar.current_job_skill_ids.mapped("skill_id")
        overlap = job_skill_ids & similar_skill_ids
        similar_total = len(similar_skill_ids)

        match_percentage = (len(overlap) / similar_total * 100) if similar_total else 0.0
        best_match = max(best_match, match_percentage)

    job['x_matching_percentage'] = best_match
]]></field>
    </record>
    <record id="x_matching_skills_field" model="ir.model.fields">
        <field name="name">x_matching_skills</field>
        <field name="field_description">Matching Skills</field>
        <field name="model_id" ref="hr.model_hr_job"/>
        <field name="ttype">many2many</field>
        <field name="store" eval="False"/>
        <field name="relation">hr.skill</field>
        <field name="depends">current_job_skill_ids,current_job_skill_ids.skill_id,x_similar_job_ids,x_similar_job_ids.current_job_skill_ids,x_similar_job_ids.current_job_skill_ids.skill_id</field>
        <field name="compute"><![CDATA[
for job in self:
    job_skill_ids = job.current_job_skill_ids.mapped("skill_id")
    similar_jobs = job.x_similar_job_ids | self.search([('x_similar_job_ids', 'in', job.id)])

    if not job_skill_ids or not similar_jobs:
        job['x_matching_skills'] = [(6, 0, [])]
        continue

    best_match = 0.0
    best_overlap = job.env['hr.skill'].browse([])

    for similar in similar_jobs:
        similar_skill_ids = similar.current_job_skill_ids.mapped("skill_id")
        if not similar_skill_ids:
            continue

        overlap = job_skill_ids & similar_skill_ids
        match_percentage = (len(overlap) / len(similar_skill_ids)) * 100

        if match_percentage > best_match:
            best_match = match_percentage
            best_overlap = overlap

    job['x_matching_skills'] = [(6, 0, best_overlap.ids)]
]]></field>
    </record>
    <record id="x_missing_skills_field" model="ir.model.fields">
        <field name="name">x_missing_skills</field>
        <field name="field_description">Missing Skills</field>
        <field name="model_id" ref="hr.model_hr_job"/>
        <field name="store" eval="False"/>
        <field name="ttype">many2many</field>
        <field name="relation">hr.skill</field>
        <field name="depends">current_job_skill_ids,current_job_skill_ids.skill_id,x_similar_job_ids,x_similar_job_ids.current_job_skill_ids,x_similar_job_ids.current_job_skill_ids.skill_id</field>
        <field name="compute"><![CDATA[
for job in self:
    job_skill_ids = job.current_job_skill_ids.mapped("skill_id")
    similar_jobs = job.x_similar_job_ids | self.search([('x_similar_job_ids', 'in', job.id)])

    if not job_skill_ids or not similar_jobs:
        job['x_missing_skills'] = [(6, 0, [])]
        continue

    best_match = 0.0
    best_missing = job.env['hr.skill'].browse([])

    for similar in similar_jobs:
        similar_skill_ids = similar.current_job_skill_ids.mapped("skill_id")
        if not similar_skill_ids:
            continue

        overlap = job_skill_ids & similar_skill_ids
        missing = similar_skill_ids - job_skill_ids
        match_percentage = (len(overlap) / len(similar_skill_ids)) * 100

        if match_percentage > best_match:
            best_match = match_percentage
            best_missing = missing

    job['x_missing_skills'] = [(6, 0, best_missing.ids)]
]]></field>
    </record>
    <record id="x_is_cv_sent_field" model="ir.model.fields">
        <field name="name">x_is_cv_sent</field>
        <field name="field_description">Is CV Sent</field>
        <field name="model_id" ref="hr_recruitment.model_hr_applicant" />
        <field name="ttype">boolean</field>
    </record>
    <!-- cv sent model fields -->
    <record id="x_applicant_id_field" model="ir.model.fields">
        <field name="name">x_applicant_id</field>
        <field name="field_description">Applicant</field>
        <field name="model_id" ref="x_cv_sent_application_model"/>
        <field name="ttype">many2one</field>
        <field name="relation">hr.applicant</field>
    </record>
    <record id="x_job_id_field_cv_sent_model" model="ir.model.fields">
        <field name="name">x_job_id</field>
        <field name="field_description">Job Position</field>
        <field name="model_id" ref="x_cv_sent_application_model"/>
        <field name="ttype">many2one</field>
        <field name="related">x_applicant_id.job_id</field>
        <field name="relation">hr.job</field>
    </record>
    <record id="x_cv_field" model="ir.model.fields">
        <field name="name">x_cv</field>
        <field name="field_description">CV</field>
        <field name="model_id" ref="x_cv_sent_application_model"/>
        <field name="ttype">many2many</field>
        <field name="relation">ir.attachment</field>
    </record>
    <record id="x_cv_sent_ids_field" model="ir.model.fields">
        <field name="name">x_cv_sent_ids</field>
        <field name="field_description">CV Sent History</field>
        <field name="model_id" ref="hr_recruitment.model_hr_applicant"/>
        <field name="ttype">one2many</field>
        <field name="relation">x_cv_sent_application</field>
        <field name="relation_field">x_applicant_id</field>
    </record>
    <record id="x_published_field" model="ir.model.fields">
        <field name="name">x_published</field>
        <field name="field_description">Published</field>
        <field name="model_id" ref="hr_recruitment.model_hr_applicant" />
        <field name="ttype">boolean</field>
    </record>
    <record id="x_availability_field" model="ir.model.fields">
        <field name="name">x_availability</field>
        <field name="field_description">Availability</field>
        <field name="model_id" ref="x_cv_sent_application_model" />
        <field name="ttype">date</field>
    </record>
    <record id="x_cv_sent_date_field" model="ir.model.fields">
        <field name="name">x_cv_sent_date</field>
        <field name="field_description">CV Sent Date</field>
        <field name="model_id" ref="x_cv_sent_application_model" />
        <field name="ttype">date</field>
    </record>
    <record id="x_is_published_field" model="ir.model.fields">
        <field name="name">x_is_published</field>
        <field name="field_description">Published</field>
        <field name="model_id" ref="x_cv_sent_application_model" />
        <field name="ttype">boolean</field>
    </record>
    <record id="x_job_positions_field" model="ir.model.fields">
        <field name="name">x_job_positions</field>
        <field name="field_description">Job Positions</field>
        <field name="model_id" ref="crm.model_crm_lead"/>
        <field name="ttype">one2many</field>
        <field name="relation">hr.job</field>
        <field name="relation_field">x_opportunity</field>
    </record>
    <record id="x_job_position_count_field" model="ir.model.fields">
        <field name="name">x_job_position_count</field>
        <field name="field_description">Job Position Count</field>
        <field name="model_id" ref="crm.model_crm_lead"/>
        <field name="ttype">integer</field>
        <field name="depends">x_job_positions.active</field>
        <field name="compute"><![CDATA[
for lead in self:
    lead['x_job_position_count'] = len(lead.x_job_positions.filtered(lambda job: job.active))
]]></field>
    </record>
    <record id="x_cv_sent_count_field" model="ir.model.fields">
        <field name="name">x_cv_sent_count</field>
        <field name="field_description">CV Sent Count</field>
        <field name="model_id" ref="crm.model_crm_lead"/>
        <field name="ttype">integer</field>
        <field name="depends">x_job_positions,x_job_positions.application_ids.x_is_cv_sent</field>
        <field name="compute"><![CDATA[
for lead in self:
    applicants = self.env['hr.applicant'].search([ ('job_id', 'in', lead.x_job_positions.ids), ('x_is_cv_sent', '=', True) ])
    lead['x_cv_sent_count'] = len(applicants)
]]></field>
    </record>
    <record id="x_cv_count_field" model="ir.model.fields">
        <field name="name">x_cv_count</field>
        <field name="field_description">CV Sent Count</field>
        <field name="model_id" ref="hr.model_hr_job"/>
        <field name="ttype">integer</field>
        <field name="depends">application_ids.x_is_cv_sent</field>
        <field name="compute"><![CDATA[
for job in self:
    job['x_cv_count'] = len(job.application_ids.filtered(lambda a: a.x_is_cv_sent))
]]></field>
    </record>
</odoo>
